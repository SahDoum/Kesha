# Это Кеша, пёс!

## Реализация скиллов
Все скиллы представляют собой классы, унаследованные от MessageHandler и подключенные к боту.
При каждом эвенте, обрабатываемым ботом, по очереди применяются зарегистрированные скиллы, пока один из них не вернет флаг, что он отработал. После этого последовательность вызовов скиллов остановится.

Все работающие скиллы лежат в модуле message_handlers.py

### Реализация простейшего скилла

В скилле надо реализовать метод **handle(self, event)**.
Он обрабатывает пришедшее событие и возвращает булевский флаг, нужно ли применять следующие скиллы.


Альтернативно, можно реализовать пару методов:
**check(self, event)** -- проверяет по эвенту, нужно ли пробовать применить последующие скиллы, и если нет вызовется метод
**process(self, event)**, в котором содержится логика выполнения скилла

### Опции скиллов

При реализации класса, в нем можно выставить следующие флаги:
* __text_only__ -- скилл применяется только на эвентах, содержащих текст. Включен по умолчанию.
* __admin_only__ -- скилл применяется только на эвентах, совершенным создателем бота
* __process_and_pass__ -- скилл отрабатывает метод **process**, при этом не прерывая последовательность вызовов скиллов

### Скилл, унаследованный от StatesMessageHandler

Такие скиллы предназначены, чтобы запоминать состояние чата и обрабатывать несколько сообщений пользователя.

В реализации  надо создать:

1) Перечисление статусов скилла:
```
States = Enum('States', 'NONE LISTENING')
```
2) Методы, обрабатывающие каждое состояние
```
def check_start(self, event):
    if event.facts.admin_commands \
       and any(command.resend for command in event.facts.admin_commands):
        self.server.send_message(event.chat.id, "Слушаю, сэр.")
        self.set_state(event, self.States.LISTENING)
        return True
    return False

def listen(self, event):
    attachments = ','.join(event.message.attachments)
    self.server.send_message(self.resend_id, event.message.text, attachment=attachments)
    self.reset_state(event)
```

3) Словарь processers с соответсвием статуса, вызываемому методу
```
processers = {
    States.NONE: check_start,
    States.LISTENING: listen
}
```

Статус скилла, впервые начавшего работу по умолчанию *NONE*

В StatesMessageHandler реализованы методы для работы с состоянием скилла в чате:

**set_status(self, event, status)** -- выставить статус в этом чате

**reset_status(self, event)** -- сбросить статус в этоом чате в NONE

### Подключение скиллов
Подключить скилл к боту можно следующиим образом:
```
server.register(YourSuperSkill)
```
Все работающие скиллы регистрируются в модуле app.py

## Event

При получении эвента, бот создает отдельный объект event, который заполняет дополнительной информацией о пользователе, чате и сообщении.
В том числе он выделяет слова из сообщения и хранит их в поле `event.message.words`

### Грамматики

Кеша пытается применить к тексту различные грамматические правила и складывает их в поле `event.message.facts`.
Для работы с сграмматиками используется библиотека [Yargy](https://yargy.readthedocs.io/ru/latest/)
